name: Deploy

on:
    push:
        branches: [master] # TODO change this to "production" when ready
env:
    API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
    GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
    GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
    FORCE_COLOR: true
jobs:
    deploy-domains-and-packages:
        runs-on: ubuntu-latest
        steps:
            - id: yarn-cache
              name: Get Yarn cache path
              run: echo "::set-output name=dir::$(yarn cache dir)"

            - uses: actions/checkout@master

            - uses: dcodeIO/setup-node-nvm@master
              with:
                  node-version: lts/*

            - uses: actions/cache@master
              name: Load Yarn cache
              with:
                  path: ${{ steps.yarn-cache.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-
            # Install all dependencies at root
            - name: Install dependencies
              run: yarn install --frozen-lockfile
            # Build the core domains along with all the packages
            # because all packages will goto core
            - name: Build core domains and all their packages
              run: yarn build:core
            # Deploy the built assets to core repo's assets/dist
            - name: Deploy to event-espresso-core
              run: source tools/deploy.sh "event-espresso-core"
            # Build REM domain without packages
            # because core will load/register the packages
            - name: Build REM with its packages
              run: yarn build:rem
            # Deploy the built assets to REM assets/dist
            - name: Deploy to REM
              run: source tools/deploy.sh "eea-recurring-events-manager"
